
COPY rstudioServer /rstudioServer
RUN cd /rstudioServer/ && 7za -y x "*.7z*"
RUN apt-get install -y psmisc libapparmor1 sudo libclang-dev libpq5
RUN dpkg -i /rstudioServer/rstudio-server-2021.09.1-372-amd64.deb
#CMD ["/usr/lib/rstudio-server/bin/rserver", "--server-daemonize", "0"]
RUN ln -s /usr/lib/rstudio-server/bin/pandoc/pandoc /usr/local/bin \
  && ln -s /usr/lib/rstudio-server/bin/pandoc/pandoc-citeproc /usr/local/bin \
  && mkdir -p /etc/R \
  && echo '\n\
    \n# Configure httr to perform out-of-band authentication if HTTR_LOCALHOST \
    \n# is not set since a redirect to localhost may not work depending upon \
    \n# where this Docker container is running. \
    \nif(is.na(Sys.getenv("HTTR_LOCALHOST", unset=NA))) { \
    \n  options(httr_oob_default = TRUE) \
    \n}' >> /usr/local/lib/R/etc/Rprofile.site \
  && echo "PATH=${PATH}" >> /usr/local/lib/R/etc/Renviron \
  && useradd rstudio \
  && echo "rstudio:rstudio" | chpasswd \
	&& mkdir /home/rstudio \
	&& chown rstudio:rstudio /home/rstudio \
	&& addgroup rstudio staff \
  &&  echo 'rsession-which-r=/usr/local/bin/R' >> /etc/rstudio/rserver.conf \
  && echo 'lock-type=advisory' >> /etc/rstudio/file-locks \
COPY configs/userconf.sh /etc/cont-init.d/userconf
COPY configs/add_shiny.sh /etc/cont-init.d/add
COPY configs/disable_auth_rserver.conf /etc/rstudio/disable_auth_rserver.conf
COPY configs/pam-helper.sh /usr/lib/rstudio-server/bin/pam-helper

EXPOSE 8787

VOLUME /home/rstudio/kitematic
ENV USER=rstudio
CMD ["/usr/lib/rstudio-server/bin/rserver", "--server-daemonize", "0", "--auth-none", "1"]
